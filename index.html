<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thermal Writer - Phomemo M02S</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef } = React;

    function ThermalWriter() {
      const [isConnected, setIsConnected] = useState(false);
      const [text, setText] = useState('');
      const [status, setStatus] = useState('Disconnected');
      const [device, setDevice] = useState(null);
      const [characteristic, setCharacteristic] = useState(null);
      const textareaRef = useRef(null);

      // ESC/POS commands
      const ESC = 0x1B;
      const GS = 0x1D;
      
      const commands = {
        init: [ESC, 0x40], // Initialize printer
        lineFeed: [0x0A],
        cut: [GS, 0x56, 0x00], // Cut paper
        alignLeft: [ESC, 0x61, 0x00],
        alignCenter: [ESC, 0x61, 0x01],
        alignRight: [ESC, 0x61, 0x02],
        bold: [ESC, 0x45, 0x01],
        boldOff: [ESC, 0x45, 0x00],
        feedLines: (n) => [ESC, 0x64, n], // Feed n lines
      };

      const connectToPrinter = async () => {
        try {
          setStatus('Connecting...');
          
          // Request Bluetooth device - accept all services to discover them
          const device = await navigator.bluetooth.requestDevice({
            filters: [{ namePrefix: 'M02' }],
            acceptAllDevices: false,
            optionalServices: ['000018f0-0000-1000-8000-00805f9b34fb', 'e7810a71-73ae-499d-8c15-faa9aef0c3f2']
          });

          setDevice(device);
          setStatus('Discovering services...');

          const server = await device.gatt.connect();
          
          // Discover all services
          const services = await server.getPrimaryServices();
          console.log('Available services:', services);
          
          let foundService = null;
          let foundChar = null;
          
          // Try to find a writable characteristic
          for (const service of services) {
            console.log('Service UUID:', service.uuid);
            const characteristics = await service.getCharacteristics();
            
            for (const char of characteristics) {
              console.log('  Characteristic UUID:', char.uuid, 'Properties:', char.properties);
              
              // Look for a writable characteristic
              if (char.properties.write || char.properties.writeWithoutResponse) {
                foundService = service;
                foundChar = char;
                console.log('  ‚úì Found writable characteristic!');
                break;
              }
            }
            
            if (foundChar) break;
          }

          if (!foundChar) {
            setStatus('No writable characteristic found. Check console for details.');
            return;
          }

          setCharacteristic(foundChar);
          setIsConnected(true);
          setStatus('Connected! Service: ' + foundService.uuid.substring(0, 8) + '...');
          
        } catch (error) {
          console.error('Connection failed:', error);
          setStatus('Connection failed: ' + error.message);
          setIsConnected(false);
        }
      };

      const disconnect = () => {
        if (device && device.gatt.connected) {
          device.gatt.disconnect();
        }
        setDevice(null);
        setCharacteristic(null);
        setIsConnected(false);
        setStatus('Disconnected');
      };

      const sendData = async (data) => {
        if (!characteristic) return;
        
        const chunkSize = 20; // Bluetooth LE characteristic write limit
        for (let i = 0; i < data.length; i += chunkSize) {
          const chunk = data.slice(i, i + chunkSize);
          await characteristic.writeValue(new Uint8Array(chunk));
          await new Promise(resolve => setTimeout(resolve, 50)); // Small delay between chunks
        }
      };

      const printText = async () => {
        if (!characteristic || !text.trim()) {
          setStatus('Nothing to print');
          return;
        }

        try {
          setStatus('Printing...');

          // Initialize
          await sendData(commands.init);

          // Send text
          const encoder = new TextEncoder();
          const lines = text.split('\n');
          
          for (const line of lines) {
            if (line.trim()) {
              const encoded = encoder.encode(line);
              await sendData(Array.from(encoded));
            }
            await sendData(commands.lineFeed);
          }

          // Feed some extra lines and cut
          await sendData(commands.feedLines(3));
          
          setStatus('Printed successfully!');
          
          setTimeout(() => {
            if (isConnected) {
              setStatus('Connected to ' + device.name);
            }
          }, 2000);

        } catch (error) {
          console.error('Print failed:', error);
          setStatus('Print failed: ' + error.message);
        }
      };

      const clearText = () => {
        setText('');
        textareaRef.current?.focus();
      };

      return (
        <div className="thermal-writer">
          <style>{`
            @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Space+Mono:wght@400;700&display=swap');
            
            * {
              margin: 0;
              padding: 0;
              box-sizing: border-box;
            }

            body {
              margin: 0;
              padding: 0;
            }

            .thermal-writer {
              min-height: 100vh;
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              padding: 2rem;
              font-family: 'JetBrains Mono', monospace;
              display: flex;
              align-items: center;
              justify-content: center;
            }

            .container {
              max-width: 600px;
              width: 100%;
              background: #f8f5f0;
              border-radius: 16px;
              box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
              overflow: hidden;
              position: relative;
            }

            .container::before {
              content: '';
              position: absolute;
              top: 0;
              left: 0;
              right: 0;
              height: 8px;
              background: repeating-linear-gradient(
                90deg,
                #000 0px,
                #000 2px,
                transparent 2px,
                transparent 4px
              );
            }

            .header {
              background: #2d2d2d;
              color: #00ff00;
              padding: 1.5rem;
              border-bottom: 3px solid #000;
            }

            .header h1 {
              font-size: 1.5rem;
              font-weight: 700;
              margin-bottom: 0.5rem;
              text-transform: uppercase;
              letter-spacing: 2px;
              text-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
            }

            .status-bar {
              display: flex;
              align-items: center;
              gap: 0.5rem;
              font-size: 0.85rem;
              margin-top: 0.5rem;
            }

            .status-indicator {
              width: 10px;
              height: 10px;
              border-radius: 50%;
              background: ${isConnected ? '#00ff00' : '#ff3333'};
              box-shadow: 0 0 10px ${isConnected ? 'rgba(0, 255, 0, 0.6)' : 'rgba(255, 51, 51, 0.6)'};
              animation: ${isConnected ? 'pulse 2s ease-in-out infinite' : 'none'};
            }

            @keyframes pulse {
              0%, 100% { opacity: 1; }
              50% { opacity: 0.5; }
            }

            .controls {
              padding: 1.5rem;
              background: #e8e5e0;
              border-bottom: 2px dashed #999;
              display: flex;
              gap: 1rem;
              flex-wrap: wrap;
            }

            .btn {
              padding: 0.75rem 1.5rem;
              border: 2px solid #000;
              background: #fff;
              color: #000;
              font-family: 'JetBrains Mono', monospace;
              font-size: 0.9rem;
              font-weight: 700;
              cursor: pointer;
              transition: all 0.2s;
              text-transform: uppercase;
              letter-spacing: 1px;
              box-shadow: 4px 4px 0 #000;
              position: relative;
            }

            .btn:hover {
              transform: translate(2px, 2px);
              box-shadow: 2px 2px 0 #000;
            }

            .btn:active {
              transform: translate(4px, 4px);
              box-shadow: 0 0 0 #000;
            }

            .btn-primary {
              background: #00ff00;
              border-color: #000;
            }

            .btn-danger {
              background: #ff3333;
              color: #fff;
            }

            .btn-secondary {
              background: #ffd700;
            }

            .btn:disabled {
              opacity: 0.5;
              cursor: not-allowed;
              transform: none;
              box-shadow: 2px 2px 0 #000;
            }

            .editor {
              padding: 2rem;
              background: #f8f5f0;
              background-image: 
                repeating-linear-gradient(
                  transparent,
                  transparent 1.5rem,
                  #d8d5d0 1.5rem,
                  #d8d5d0 calc(1.5rem + 1px)
                );
            }

            .char-count {
              font-size: 0.75rem;
              color: #666;
              margin-bottom: 1rem;
              font-family: 'Space Mono', monospace;
            }

            textarea {
              width: 100%;
              min-height: 400px;
              padding: 1rem;
              border: 2px solid #000;
              background: rgba(255, 255, 255, 0.8);
              font-family: 'Space Mono', monospace;
              font-size: 1rem;
              line-height: 1.5rem;
              resize: vertical;
              color: #000;
              box-shadow: inset 2px 2px 8px rgba(0, 0, 0, 0.1);
            }

            textarea:focus {
              outline: none;
              border-color: #667eea;
              background: rgba(255, 255, 255, 0.95);
            }

            textarea::placeholder {
              color: #999;
              font-style: italic;
            }

            .footer {
              padding: 1rem 1.5rem;
              background: #2d2d2d;
              color: #00ff00;
              font-size: 0.75rem;
              text-align: center;
              font-family: 'Space Mono', monospace;
            }

            .preview-note {
              background: #fff3cd;
              border: 2px dashed #856404;
              padding: 1rem;
              margin: 1rem 1.5rem;
              border-radius: 4px;
              font-size: 0.85rem;
              color: #856404;
            }
          `}</style>

          <div className="container">
            <div className="header">
              <h1>‚ö° Thermal Writer</h1>
              <div className="status-bar">
                <div className="status-indicator"></div>
                <span>{status}</span>
              </div>
            </div>

            <div className="controls">
              {!isConnected ? (
                <button className="btn btn-primary" onClick={connectToPrinter}>
                  Connect to Printer
                </button>
              ) : (
                <>
                  <button className="btn btn-danger" onClick={disconnect}>
                    Disconnect
                  </button>
                  <button className="btn btn-primary" onClick={printText} disabled={!text.trim()}>
                    Print
                  </button>
                  <button className="btn btn-secondary" onClick={clearText}>
                    Clear
                  </button>
                </>
              )}
            </div>

            <div className="preview-note">
              <strong>üí° Tip:</strong> Phomemo M02S prints approximately 32 characters per line. 
              Keep your lines concise for best results!
              <br/><br/>
              <strong>üîç Debug Mode:</strong> Open your browser's console (F12) to see discovered Bluetooth services and UUIDs.
            </div>

            <div className="editor">
              <div className="char-count">
                {text.length} characters ‚Ä¢ {text.split('\n').length} lines
              </div>
              <textarea
                ref={textareaRef}
                value={text}
                onChange={(e) => setText(e.target.value)}
                placeholder="Start typing your thermal masterpiece..."
                spellCheck="false"
              />
            </div>

            <div className="footer">
              PHOMEMO M02S ‚Ä¢ WEB BLUETOOTH ‚Ä¢ THERMAL PRINTING
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<ThermalWriter />);
  </script>
</body>
</html>
