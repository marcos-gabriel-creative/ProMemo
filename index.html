<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phomemo M02S Word Processor</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f0f0f0; display: flex; flex-direction: column; height: 100vh; }
        .header { background: #2c3e50; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .status-indicator { width: 10px; height: 10px; border-radius: 50%; background: #e74c3c; margin-left: 10px; }
        .status-indicator.connected { background: #2ecc71; box-shadow: 0 0 5px #2ecc71; }
        .toolbar { background: white; padding: 10px 20px; display: flex; gap: 20px; align-items: center; border-bottom: 1px solid #ddd; flex-wrap: wrap; }
        .toolbar-group { display: flex; gap: 5px; align-items: center; border-right: 1px solid #ddd; padding-right: 15px; }
        button { padding: 8px 15px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        button:disabled { background: #95a5a6; }
        .editor-container { flex: 1; display: flex; justify-content: center; padding: 20px; overflow-y: auto; }
        .paper { background: white; width: 384px; min-height: 500px; padding: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        #editor { width: 100%; min-height: 100%; border: none; outline: none; font-family: 'Courier New', monospace; font-size: 14pt; resize: none; white-space: pre-wrap; }
        #debugConsole { position: fixed; bottom: 20px; right: 20px; width: 300px; height: 150px; background: rgba(0,0,0,0.8); color: #0f0; font-family: monospace; font-size: 10px; padding: 10px; overflow-y: auto; display: none; }
    </style>
</head>
<body>
    <div class="header">
        <h1>M02S Word Processor</h1>
        <div style="display:flex; align-items:center;">
            <span id="connectionText">Disconnected</span>
            <div class="status-indicator" id="statusIndicator"></div>
            <button id="connectBtn" style="margin-left:15px;">Connect Printer</button>
        </div>
    </div>

    <div class="toolbar">
        <div class="toolbar-group">
            <button id="printBtn" disabled style="background:#2ecc71;">Print</button>
            <button id="clearBtn" style="background:#e74c3c;">Clear</button>
        </div>
        <div class="toolbar-group">
            <select id="fontSize">
                <option value="12">12pt</option>
                <option value="16" selected>16pt</option>
                <option value="20">20pt</option>
                <option value="24">24pt</option>
            </select>
        </div>
    </div>

    <div class="editor-container">
        <div class="paper">
            <textarea id="editor" placeholder="Start typing..."></textarea>
        </div>
    </div>

    <div id="debugConsole"></div>
    <canvas id="printCanvas" style="display:none;"></canvas>

    <script>
        let device, characteristic;
        const SERVICE_UUID = '0000ff00-0000-1000-8000-00805f9b34fb';
        const CHAR_UUID = '0000ff01-0000-1000-8000-00805f9b34fb';

        const debug = (msg) => {
            const console = document.getElementById('debugConsole');
            console.style.display = 'block';
            console.innerHTML += `> ${msg}<br>`;
            console.scrollTop = console.scrollHeight;
        };

        document.getElementById('connectBtn').onclick = async () => {
            try {
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'M02' }, { namePrefix: 'Phomemo' }],
                    optionalServices: [SERVICE_UUID]
                });
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                characteristic = await service.getCharacteristic(CHAR_UUID);
                
                document.getElementById('statusIndicator').classList.add('connected');
                document.getElementById('connectionText').innerText = "Connected";
                document.getElementById('printBtn').disabled = false;
                debug("Printer Ready.");
            } catch (err) {
                debug("Error: " + err.message);
            }
        };

        async function sendToPrinter(data) {
            const CHUNK = 20;
            for (let i = 0; i < data.length; i += CHUNK) {
                const slice = data.slice(i, i + CHUNK);
                await characteristic.writeValueWithoutResponse(new Uint8Array(slice));
                await new Promise(r => setTimeout(r, 35)); // Safe delay for buffer
            }
        }

        document.getElementById('printBtn').onclick = async () => {
            const canvas = document.getElementById('printCanvas');
            const ctx = canvas.getContext('2d');
            const editor = document.getElementById('editor');
            const fSize = document.getElementById('fontSize').value;

            // Setup Canvas Width (M02S = 384px)
            canvas.width = 384;
            const lines = editor.value.split('\n');
            canvas.height = lines.length * (fSize * 1.5) + 40;

            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'black';
            ctx.font = `${fSize}pt Courier New`;
            
            lines.forEach((line, i) => {
                ctx.fillText(line, 10, 40 + (i * fSize * 1.5));
            });

            // Process Image to Bitmap
            const imgData = ctx.getImageData(0, 0, 384, canvas.height);
            const bitmap = [];
            for (let y = 0; y < canvas.height; y++) {
                const row = new Uint8Array(48);
                for (let x = 0; x < 384; x++) {
                    const idx = (y * 384 + x) * 4;
                    const avg = (imgData.data[idx] + imgData.data[idx+1] + imgData.data[idx+2]) / 3;
                    if (avg < 128) row[Math.floor(x / 8)] |= (0x80 >> (x % 8));
                }
                bitmap.push(...row);
            }

            try {
                debug("Starting Print Job...");
                // Handshake
                await sendToPrinter([0x1B, 0x40]); // Reset
                await sendToPrinter([0x1F, 0x11, 0x02, 0x04]); // Wake

                // Block Splitting (Required for M02S)
                const MAX_BLOCK = 255;
                for (let i = 0; i < canvas.height; i += MAX_BLOCK) {
                    const blockLines = Math.min(MAX_BLOCK, canvas.height - i);
                    const blockData = bitmap.slice(i * 48, (i + blockLines) * 48);
                    
                    const header = [
                        0x1D, 0x76, 0x30, 0x00, 
                        48, 0x00, // 48 bytes wide
                        blockLines & 0xFF, (blockLines >> 8) & 0xFF
                    ];
                    await sendToPrinter(header);
                    await sendToPrinter(blockData);
                }

                // Feed and End
                await sendToPrinter([0x1B, 0x64, 0x03, 0x1F, 0x11, 0x08]);
                debug("Print Complete.");
            } catch (err) {
                debug("Print Error: " + err.message);
            }
        };

        document.getElementById('clearBtn').onclick = () => {
            document.getElementById('editor').value = "";
        };
    </script>
</body>
</html>
